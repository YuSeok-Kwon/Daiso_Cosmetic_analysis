# 크롤링 시스템 설명서

다이소 뷰티/위생 카테고리 제품 정보, 리뷰, 성분 데이터 수집 시스템

---

## 디렉토리 구조

```
Crawling/
├── daiso_beauty_crawler.py     # 메인 크롤러
├── config.py                   # 설정 (카테고리, URL 등)
├── utils.py                    # 유틸리티 (로거, 날짜 등)
├── requirements.txt            # 의존성 패키지
├── .env                        # 환경변수 (API 키)
│
├── modules/                    # 핵심 모듈
│   ├── ocr_utils_split.py      # 이미지 분할 OCR
│   ├── clova_ocr.py            # 네이버 클로바 OCR
│   ├── ingredient_parser.py    # 성분 파서 (OCR 교정 포함)
│   ├── ingredient_parser_v2.py # 성분 파서 v2 (고도화)
│   ├── ingredient_detector.py  # 성분 이미지 감지
│   ├── ingredient_postprocessor.py  # 성분 후처리
│   ├── image_preprocessor.py   # 이미지 전처리
│   ├── halal_vegan_api.py      # 할랄/비건 외부 API
│   ├── halal_vegan_checker.py  # 할랄/비건 로컬 DB 체커
│   ├── certification_api.py    # 인증 API
│   └── driver_setup.py         # 셀레니움 드라이버 설정
│
├── scripts/                    # 실행 스크립트
├── tests/                      # 테스트 코드
├── test_results/               # 테스트 결과
├── logs/                       # 로그 파일
└── cache/                      # 캐시 데이터
```

---

## 1. 크롤링 대상 카테고리

### 다이소 뷰티/위생 전체 카테고리

| 대분류       | 소분류                                                                          |
| ------------ | ------------------------------------------------------------------------------- |
| **스킨케어** | 기초스킨케어, 립케어, 팩/마스크, 자외선차단제, 클렌징/필링                      |
| **메이크업** | 베이스메이크업, 아이메이크업, 립메이크업, 치크/하이라이터, 퍼프브러시세척, 향수 |
| **네일용품** | 네일리무버, 네일아트도구, 네일패치/팁, 매니큐어, 네일케어용품                   |
| **맨케어**   | 남성향수, 남성메이크업, 클렌징/쉐이빙, 남성스킨케어, 남성용면도기               |
| **미용소품** | 미용가위, 거울, 미용소도구, 화장소품수납, 공병, 세안소품                        |

---

## 2. 수집 데이터

### 2.1 제품 정보 (products)

| 필드            | 설명                             |
| --------------- | -------------------------------- |
| `product_code`  | 제품 코드 (PK)                   |
| `category_home` | 홈 카테고리 (뷰티/위생)          |
| `category_1`    | 대분류 (스킨케어, 메이크업 등)   |
| `category_2`    | 소분류 (기초스킨케어, 립케어 등) |
| `brand`         | 브랜드명                         |
| `name`          | 제품명                           |
| `price`         | 가격                             |
| `country`       | 원산지                           |
| `likes`         | 좋아요 수                        |
| `shares`        | 공유 수                          |
| `group`         | 제품 그룹                        |

### 2.2 리뷰 (reviews)

| 필드           | 설명               |
| -------------- | ------------------ |
| `product_code` | 제품 코드 (FK)     |
| `date`         | 리뷰 작성일        |
| `user_masked`  | 마스킹된 사용자명  |
| `rating`       | 평점 (1~5)         |
| `text`         | 리뷰 텍스트        |
| `image_count`  | 첨부 이미지 수     |
| `user_id`      | 익명화된 사용자 ID |
| `order_id`     | 주문 ID            |

### 2.3 성분 (ingredients)

| 필드         | 설명            |
| ------------ | --------------- |
| `product_id` | 제품 코드 (FK)  |
| `name`       | 제품명          |
| `ingredient` | 성분명 (정규화) |
| `can_halal`  | 할랄 가능 여부  |
| `can_vegan`  | 비건 가능 여부  |
| `not_halal`  | 할랄 불가 여부  |

---

## 3. 핵심 모듈 설명

### 3.1 OCR 처리 파이프라인

```
이미지 URL
    ↓
[image_preprocessor.py] 이미지 전처리
    - RGB 변환
    - 해상도 조정 (1.5배 확대)
    - 대비/선명도 향상
    ↓
[ocr_utils_split.py] 분할 OCR        ← 로컬 OCR (EasyOCR)
    - 긴 이미지를 섹션별로 분할
    - EasyOCR (한국어/영어)
    - 텍스트 결합
    ↓
[clova_ocr.py] Naver Clova OCR       ← 클라우드 OCR (선택)
    - 한국어 OCR 특화
    - 화장품 성분표 인식 최적화
    - API 기반 고정밀 인식
    ↓
[ingredient_parser.py] OCR 교정
    - 300+ OCR 오인식 패턴 교정
    - 숫자-한글 혼동 (0→아이, 1→레이)
    - 자음 혼동 (알→일)
    ↓
[ingredient_parser_v2.py] 성분 파싱
    - 줄바꿈 병합
    - 성분명 분리 (쉼표, 슬래시)
    - 성분명 정규화
```

### 3.2 Naver Clova OCR

#### 개요

- **한국어 OCR 특화**: 화장품 성분표 인식에 최적화
- **지원 방식**: URL 이미지, 바이트 이미지
- **출력 형식**: 전체 텍스트, 구조화 데이터 (위치/신뢰도 포함)

#### 환경변수 설정

```bash
# .env 파일
CLOVA_OCR_URL=https://********.apigw.ntruss.com/custom/v1/****/infer
CLOVA_OCR_SECRET=****************
```

#### 사용 예시

```python
from modules.clova_ocr import get_clova_client

client = get_clova_client()

# API 사용 가능 여부 확인
if client.is_available():
    # URL에서 텍스트 추출
    text = client.extract_text_from_url(image_url)

    # 구조화된 데이터 추출 (위치, 신뢰도 포함)
    data = client.extract_structured_data(image_url)
```

#### EasyOCR vs Clova OCR

| 항목   | EasyOCR (로컬)     | Clova OCR (클라우드) |
| ------ | ------------------ | -------------------- |
| 비용   | 무료               | 유료 (API 호출당)    |
| 속도   | 느림 (GPU 없을 시) | 빠름                 |
| 정확도 | 보통               | 높음 (한국어 특화)   |
| 인터넷 | 불필요             | 필요                 |
| 설정   | 간단               | API 키 필요          |

### 3.3 OCR 오인식 교정 패턴

| 오류 유형     | 예시               | 교정               |
| ------------- | ------------------ | ------------------ |
| 소듐 변형     | 소톱, 소득, 소문   | 소듐               |
| 숫자 0 오인식 | 폴리아0소부텐      | 폴리아이소부텐     |
| 숫자 1 오인식 | 스테아러1이트      | 스테아레이트       |
| 자음 혼동     | 하이일루로네이트   | 하이알루로네이트   |
| 글리서/글리세 | 트라이글리서라이드 | 트라이글리세라이드 |

### 3.4 성분 추출 다중 소스

```python
def extract_ingredients_multi_source(driver, product_code, product_name):
    """
    다중 소스에서 성분 추출 및 교차 검증

    소스 1: 이미지 ALT 속성 (전성분 텍스트 포함 시)
    소스 2: OCR (제품 상세 이미지)

    → 교차 검증으로 신뢰도 향상
    """
```

### 3.5 할랄/비건 판정

```Markdown
[halal_vegan_checker.py]
    ↓
1. 동물성 성분 DB 체크 (ANIMAL_DERIVED_INGREDIENTS)
   - 라놀린, 콜라겐, 케라틴, 밀랍, 꿀, 실크 등
   → 비건 불가
    ↓
2. 할랄 금지 성분 DB 체크 (HARAM_INGREDIENTS)
   - 알코올류 (에탄올, 변성알코올 등)
   - 돼지 유래 (돼지콜라겐, 돼지젤라틴 등)
   → 할랄 불가
    ↓
3. 결과
   - can_halal: 할랄 가능
   - can_vegan: 비건 가능
   - not_halal: 할랄 불가
```
