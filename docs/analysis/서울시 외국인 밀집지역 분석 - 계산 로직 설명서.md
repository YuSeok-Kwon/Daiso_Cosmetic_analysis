# 서울시 외국인 밀집지역 분석 - 계산 로직 설명서

## 목차

1. [데이터 구조](#1-데이터-구조)
2. [전처리 과정](#2-전처리-과정)
3. [방법 A: 시간대별 분석](#3-방법-a-시간대별-분석)
4. [방법 B: 평균 스냅샷](#4-방법-b-평균-스냅샷)
5. [방법 C: Person-Hour](#5-방법-c-person-hour)
6. [비율 계산](#6-비율-계산)
7. [복합점수 계산](#7-복합점수-계산)
8. [검증 (B vs C)](#8-검증-b-vs-c)
9. [전체 계산 흐름 예시](#9-전체-계산-흐름-예시)

---

## 1. 데이터 구조

### 1.1 원본 데이터 (TEMP_FOREIGNER_YYYYMMDD.csv)

| 컬럼명                 | 설명              | 예시          |
| ---------------------- | ----------------- | ------------- |
| 기준일ID               | 날짜              | 20250101      |
| 시간대구분             | 0~23시            | 12            |
| 행정동코드             | 10자리 코드       | 1114051500    |
| 집계구코드             | 상세 지역 코드    | 1101072010001 |
| 총생활인구수           | 해당 시간 총 인구 | 5,000         |
| 중국인체류인구수       | 중국인 수         | 1,500         |
| 중국외외국인체류인구수 | 비중국 외국인 수  | 2,000         |

### 1.2 데이터 특성

```
통신데이터 = 시간대별 "스냅샷"

예: 12시 데이터 = "12시 정각에 해당 지역에 있는 사람 수"

같은 사람이 여러 시간대에 카운트될 수 있음 (정상)
   - 10시에 중구에 있던 사람 → 10시 데이터에 카운트
   - 11시에도 중구에 있음 → 11시 데이터에도 카운트
   - 이것은 "중복"이 아니라 "체류 시간"을 반영하는 것
```

---

## 2. 전처리 과정

### 2.1 다이소 영업시간 필터링

```python
DAISO_HOURS = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]  # 13개 시간대

df = df[df['시간대'].isin(DAISO_HOURS)]
```

### 2.2 마스킹 값 처리

```python
# '*' = 소수값 마스킹 → 0으로 대체 (최소치 추정)
df['중국인체류인구수'] = df['중국인체류인구수'].replace('*', 0)
df['중국외외국인체류인구수'] = df['중국외외국인체류인구수'].replace('*', 0)
```

### 2.3 외국인 체류인구수 계산

```python
외국인체류인구수 = 중국인체류인구수 + 중국외외국인체류인구수
```

### 2.4 자치구 매핑

```python
# 행정동코드 앞 5자리 = 자치구 코드
구코드 = 행정동코드[:5]

# 예: 11140 → 중구
GU_CODE_MAP = {
    '11110': '종로구',
    '11140': '중구',
    '11170': '용산구',
    ...
}
```

---

## 3. 방법 A: 시간대별 분석

### 3.1 목적

- 피크타임 파악
- 시간대별 외국인 분포 확인

### 3.2 계산 공식

```
시간대별_외국인 = Σ(해당 시간대 외국인) / 일수
```

### 3.3 계산 예시 (중구, 7일 기준)

| 날짜       | 10시    | 11시    | 12시    | ... | 22시    |
| ---------- | ------- | ------- | ------- | --- | ------- |
| 1일        | 30,000  | 32,000  | 35,000  | ... | 25,000  |
| 2일        | 31,000  | 33,000  | 36,000  | ... | 26,000  |
| ...        | ...     | ...     | ...     | ... | ...     |
| 7일        | 29,000  | 31,000  | 34,000  | ... | 24,000  |
| **합계**   | 210,000 | 224,000 | 245,000 | ... | 175,000 |
| **일평균** | 30,000  | 32,000  | 35,000  | ... | 25,000  |

### 3.4 피크시간 계산

```python
피크시간 = 일평균이 가장 높은 시간대
피크_외국인수 = 해당 시간대의 일평균 값
```

---

## 4. 방법 B: 평균 스냅샷

### 4.1 목적

- 구별 순위 비교 (주요 랭킹 지표)
- "평균적으로 몇 명이 있는가?"

### 4.2 계산 공식

```
평균_외국인 = Σ(10~22시 모든 외국인) / 13시간 / 일수
```

### 4.3 계산 예시 (중구, 1일 기준)

```
10시: 30,000명
11시: 32,000명
12시: 35,000명
13시: 36,000명
14시: 35,500명
15시: 34,000명
16시: 33,000명
17시: 34,500명
18시: 38,000명
19시: 40,000명
20시: 41,000명
21시: 41,500명
22시: 25,000명
─────────────────
합계: 455,500명

평균_외국인 = 455,500 / 13시간 = 35,038명
```

### 4.4 연간 계산 (356일)

```
1일차 합계: 455,500
2일차 합계: 460,000
...
356일차 합계: 450,000
─────────────────────
총 합계: 162,500,000

평균_외국인 = 162,500,000 / 13 / 356 = 35,131명
```

### 4.5 의미

```
평균_외국인 35,131명 =
"다이소 영업시간 동안 중구에는 평균적으로 35,131명의 외국인이 있다"
```

---

## 5. 방법 C: Person-Hour

### 5.1 목적

- 체류 가치 분석
- 리테일 관점의 "구매 기회" 측정

### 5.2 계산 공식

```
외국인_PH = Σ(10~22시 모든 외국인) / 일수
```

**방법 B와의 차이: 13으로 나누지 않음**

### 5.3 계산 예시 (중구, 1일 기준)

```
10시: 30,000명
11시: 32,000명
...
22시: 25,000명
─────────────────
합계: 455,500 Person-Hour
```

### 5.4 연간 계산 (356일)

```
총 합계: 162,500,000

외국인_PH = 162,500,000 / 356 = 456,461 PH
```

### 5.5 Person-Hour 해석

```
456,461 PH의 의미:

해석 1: 456,461명이 각 1시간씩 체류
해석 2: 35,112명이 13시간(종일) 체류
해석 3: 100,000명이 평균 4.6시간씩 체류

→ 모두 같은 456,461 PH
```

### 5.6 방법 B와 C의 관계

```
외국인_PH = 평균_외국인 × 13

검증:
35,131 × 13 = 456,703 ≈ 456,708 (0.001% 차이, 반올림 오차)
```

---

## 6. 비율 계산

### 6.1 외국인비율 (총생활인구 대비)

```
외국인비율(%) = 평균_외국인 / 평균_총생활인구 × 100
```

**예시 (중구):**

```
평균_외국인 = 35,131명
평균_총생활인구 = 35,239명

외국인비율 = 35,131 / 35,239 × 100 = 99.69%
```

### 6.2 중국인비율 (외국인 중)

```
중국인비율(%) = 평균_중국인 / (평균_중국인 + 평균_비중국) × 100
```

**예시 (중구):**

```
평균_중국인 = 12,678명
평균_비중국 = 22,453명

중국인비율 = 12,678 / (12,678 + 22,453) × 100 = 36.09%
```

### 6.3 비율 구조 도식

```
총생활인구 (35,239명)
│
├── 외국인 (35,131명) ─────────── 외국인비율 99.69%
│   │
│   ├── 중국인 (12,678명) ─────── 중국인비율 36.09%
│   │
│   └── 비중국 외국인 (22,453명)
│
└── 내국인 (108명)
```

---

## 7. 복합점수 계산

### 7.1 목적

- 외국인 체류인구 + S-DoT 유동인구를 결합
- 다이소 정책 우선순위 결정

### 7.2 계산 공식

```
복합점수 = 외국인_정규화 + 유동량_정규화
```

### 7.3 Min-Max 정규화

```python
외국인_정규화 = (평균_외국인 - 최소값) / (최대값 - 최소값)
유동량_정규화 = (일평균_방문자 - 최소값) / (최대값 - 최소값)
```

정규화 결과: 0 ~ 1 범위

### 7.4 계산 예시

**원본 데이터:**

| 자치구 | 평균\_외국인  | 일평균\_방문자 |
| ------ | ------------- | -------------- |
| 중구   | 35,131 (최대) | 105,819        |
| 강남구 | 18,203        | 127,543 (최대) |
| 도봉구 | 173 (최소)    | 87,383         |
| 금천구 | 283           | 26,028 (최소)  |

**정규화:**

```
중구:
- 외국인_정규화 = (35,131 - 173) / (35,131 - 173) = 1.0
- 유동량_정규화 = (105,819 - 26,028) / (127,543 - 26,028) = 0.79
- 복합점수 = 1.0 + 0.79 = 1.79

강남구:
- 외국인_정규화 = (18,203 - 173) / (35,131 - 173) = 0.52
- 유동량_정규화 = (127,543 - 26,028) / (127,543 - 26,028) = 1.0
- 복합점수 = 0.52 + 1.0 = 1.52
```

### 7.5 점수 범위 및 해석

| 점수 | 의미                                  |
| ---- | ------------------------------------- |
| 2.0  | 외국인 1위 + 유동량 1위 (이론적 최대) |
| 1.5  | 둘 다 상위권                          |
| 1.0  | 둘 다 중간 또는 한쪽만 높음           |
| 0.0  | 외국인 최하 + 유동량 최하             |

---

## 8. 검증 (B vs C)

### 8.1 목적

- 방법 B와 C가 같은 원본에서 계산되었으므로 관계식 검증
- 계산 오류 확인

### 8.2 검증 공식

```
평균_외국인 × 13 ≈ 외국인_PH

차이(%) = |평균×13 - 외국인_PH| / 외국인_PH × 100
```

### 8.3 검증 결과 예시

| 자치구 | 평균\_외국인 | 평균×13 | 외국인\_PH | 차이 | 차이(%) |
| ------ | ------------ | ------- | ---------- | ---- | ------- |
| 중구   | 35,131       | 456,703 | 456,708    | 5명  | 0.001%  |
| 중랑구 | 223          | 2,899   | 2,903      | 4명  | 0.138%  |

### 8.4 차이 발생 원인

```python
# 반올림이 각각 적용되어 미세한 차이 발생
평균_외국인 = round(합계 / 13 / 일수)  # 반올림 1회
외국인_PH = round(합계 / 일수)          # 반올림 1회

# 검증 시
평균×13 = 평균_외국인 × 13  # 이미 반올림된 값에 13을 곱함
```

### 8.5 판정 기준

| 차이(%) | 판정               |
| ------- | ------------------ |
| < 1%    | 정상 (반올림 오차) |
| 1~5%    | 확인 필요          |
| > 5%    | 계산 오류 가능성   |

---

## 9. 전체 계산 흐름 예시

### 9.1 입력 데이터 (중구, 2025년 1월 1일)

```
시간대 | 총생활인구 | 중국인 | 비중국외국인
──────┼───────────┼────────┼────────────
 10시 │   30,500  │ 10,000 │   20,000
 11시 │   32,500  │ 11,000 │   21,000
 12시 │   35,500  │ 12,000 │   23,000
 13시 │   36,500  │ 12,500 │   23,500
 14시 │   36,000  │ 12,000 │   23,500
 15시 │   34,500  │ 11,500 │   22,500
 16시 │   33,500  │ 11,000 │   22,000
 17시 │   35,000  │ 11,500 │   23,000
 18시 │   38,500  │ 13,000 │   25,000
 19시 │   40,500  │ 14,000 │   26,000
 20시 │   41,500  │ 14,500 │   26,500
 21시 │   42,000  │ 15,000 │   26,500
 22시 │   25,500  │  8,500 │   16,500
```

### 9.2 Step 1: 외국인 계산

```
외국인 = 중국인 + 비중국외국인

10시: 10,000 + 20,000 = 30,000
11시: 11,000 + 21,000 = 32,000
...
```

### 9.3 Step 2: 방법별 계산 (1일 기준)

```
[방법 A - 시간대별]
10시 외국인: 30,000명
11시 외국인: 32,000명
...
피크시간: 21시 (41,500명)

[방법 B - 평균 스냅샷]
합계 = 30,000 + 32,000 + ... + 25,000 = 456,000
평균_외국인 = 456,000 / 13 = 35,077명

[방법 C - Person-Hour]
외국인_PH = 456,000 PH
```

### 9.4 Step 3: 연간 집계 (356일)

```
1일차 합계: 456,000
2일차 합계: 458,000
...
356일차 합계: 455,000
─────────────────────
총 합계: 162,587,648

[방법 B]
평균_외국인 = 162,587,648 / 13 / 356 = 35,131명

[방법 C]
외국인_PH = 162,587,648 / 356 = 456,708 PH
```

### 9.5 Step 4: 검증

```
평균×13 = 35,131 × 13 = 456,703
외국인_PH = 456,708

차이 = |456,703 - 456,708| = 5명
차이(%) = 5 / 456,708 × 100 = 0.001%

→ 정상
```

---
