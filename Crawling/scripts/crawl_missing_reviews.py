"""
제품 정보는 있지만 리뷰가 누락된 제품의 리뷰만 크롤링
"""
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
from daiso_beauty_crawler import crawl_product_detail
from utils import setup_logger, get_date_string
import time

# 로거 설정
logger = setup_logger('missing_reviews', 'missing_reviews.log')

# 리뷰만 필요한 제품 코드 목록 (제품 정보는 있지만 리뷰가 없는 829개)
missing_codes = [
    22358, 31386, 41301, 41378, 50371, 55677, 58829,
    58830, 58831, 59207, 59336, 60905, 60906, 67128,
    67129, 67851, 73008, 84456, 84989, 85092, 1001854,
    1001855, 1001856, 1001857, 1001858, 1004118, 1004119, 1004130,
    1004147, 1004148, 1004149, 1004150, 1004151, 1004152, 1004153,
    1004450, 1004451, 1004452, 1004454, 1004455, 1004456, 1004458,
    1005698, 1005699, 1005700, 1005701, 1007362, 1007854, 1007855,
    1010998, 1011293, 1012961, 1012962, 1014783, 1014785, 1014786,
    1017957, 1018012, 1018013, 1018015, 1018022, 1018023, 1018024,
    1018035, 1018036, 1018037, 1018038, 1018039, 1018161, 1021252,
    1021253, 1021254, 1023472, 1026629, 1026630, 1026631, 1027157,
    1027327, 1027328, 1027329, 1029923, 1030629, 1031076, 1031078,
    1033192, 1033193, 1034224, 1034515, 1034516, 1034517, 1034518,
    1034520, 1034522, 1034523, 1034524, 1034525, 1034526, 1035071,
    1035074, 1035080, 1035081, 1035082, 1035084, 1035214, 1035502,
    1035553, 1038068, 1038219, 1038226, 1038237, 1038255, 1038327,
    1038328, 1038593, 1038594, 1038603, 1038604, 1038605, 1038743,
    1039238, 1039492, 1039493, 1039494, 1039543, 1039936, 1039937,
    1039938, 1039941, 1040079, 1040471, 1040472, 1040473, 1041083,
    1041084, 1041110, 1041114, 1041655, 1041677, 1041678, 1041679,
    1041680, 1041681, 1041755, 1041890, 1041891, 1041892, 1042158,
    1042248, 1042526, 1042615, 1042619, 1042627, 1042629, 1042631,
    1042638, 1042979, 1043646, 1043650, 1043657, 1043744, 1043746,
    1043748, 1043749, 1043750, 1043751, 1044402, 1044403, 1044404,
    1044405, 1044552, 1044845, 1044846, 1044848, 1044849, 1044964,
    1044971, 1044972, 1045145, 1045146, 1045147, 1045148, 1045186,
    1045419, 1045420, 1045421, 1045422, 1045423, 1045424, 1045425,
    1045426, 1045430, 1045432, 1045433, 1045435, 1045436, 1045437,
    1045527, 1045531, 1045532, 1045534, 1045537, 1045540, 1045541,
    1045542, 1045831, 1045832, 1045833, 1045834, 1046400, 1046401,
    1046781, 1046782, 1046783, 1046784, 1047511, 1048273, 1048274,
    1048275, 1048276, 1048277, 1048808, 1048809, 1048810, 1048911,
    1048912, 1048913, 1048914, 1048915, 1048916, 1048917, 1049277,
    1049278, 1049285, 1049287, 1049289, 1049291, 1049292, 1049295,
    1049296, 1049297, 1049298, 1049299, 1049301, 1049302, 1049323,
    1049324, 1049333, 1050068, 1050069, 1050070, 1050177, 1050178,
    1050179, 1050181, 1051351, 1051352, 1051353, 1051357, 1051370,
    1051373, 1051381, 1051382, 1051383, 1051387, 1051389, 1051390,
    1051391, 1051392, 1051730, 1051731, 1051735, 1051736, 1051737,
    1051744, 1051745, 1052337, 1052413, 1052414, 1052415, 1052417,
    1052418, 1052419, 1052420, 1052422, 1052423, 1052425, 1052426,
    1052435, 1052436, 1052437, 1052438, 1052442, 1052592, 1052593,
    1052594, 1052595, 1052624, 1053332, 1053333, 1053454, 1053456,
    1053481, 1053494, 1053498, 1053499, 1053500, 1053501, 1053502,
    1053503, 1053504, 1053505, 1053506, 1054346, 1054347, 1054366,
    1054672, 1055152, 1055153, 1055155, 1055156, 1055157, 1055158,
    1055159, 1055160, 1055161, 1055162, 1055362, 1055364, 1055367,
    1055371, 1055374, 1056651, 1056652, 1056653, 1056654, 1056655,
    1056668, 1057223, 1057313, 1057314, 1057350, 1057352, 1057356,
    1058209, 1058210, 1058212, 1058213, 1058460, 1058470, 1059029,
    1059030, 1059031, 1059097, 1059098, 1059203, 1059416, 1059502,
    1059503, 1059504, 1059505, 1059506, 1059766, 1059830, 1059831,
    1059832, 1059833, 1059834, 1059835, 1059836, 1059837, 1059838,
    1059839, 1059840, 1059925, 1059931, 1059937, 1060063, 1060114,
    1060115, 1060116, 1060117, 1060118, 1060119, 1060120, 1060122,
    1060123, 1060124, 1060126, 1060127, 1060128, 1060129, 1060130,
    1060211, 1060212, 1060213, 1060215, 1060216, 1060217, 1060474,
    1060475, 1060476, 1060477, 1060478, 1060479, 1060480, 1060482,
    1060483, 1060485, 1060486, 1060487, 1060488, 1060489, 1060497,
    1060498, 1060499, 1060500, 1060501, 1060502, 1060503, 1060504,
    1060505, 1060506, 1060507, 1060508, 1060509, 1060510, 1060511,
    1060546, 1060547, 1060548, 1060642, 1060647, 1060648, 1060649,
    1060650, 1060651, 1060652, 1060653, 1060654, 1060655, 1060656,
    1060657, 1060658, 1060659, 1060660, 1060661, 1060662, 1060663,
    1060664, 1060665, 1060666, 1060667, 1060668, 1060669, 1060670,
    1060671, 1060672, 1060673, 1060674, 1060675, 1060676, 1060677,
    1060678, 1060679, 1060680, 1060681, 1060744, 1060745, 1060746,
    1060747, 1060748, 1061143, 1061144, 1061146, 1061147, 1061148,
    1061149, 1061150, 1061151, 1061153, 1061155, 1061156, 1061157,
    1061158, 1061159, 1061160, 1061162, 1061163, 1061380, 1061381,
    1061382, 1061383, 1061385, 1061387, 1061392, 1061394, 1061396,
    1061398, 1061448, 1061449, 1061450, 1061451, 1061452, 1061453,
    1061454, 1061468, 1061470, 1061473, 1061477, 1061480, 1061482,
    1061530, 1061565, 1061622, 1061630, 1061707, 1061709, 1061710,
    1061711, 1061712, 1061812, 1061813, 1061814, 1061815, 1061816,
    1061817, 1061818, 1061819, 1061820, 1061821, 1061822, 1061823,
    1061824, 1061825, 1061827, 1061828, 1061830, 1061832, 1061833,
    1061834, 1061836, 1061837, 1061838, 1061839, 1061877, 1061878,
    1061879, 1061880, 1061881, 1061901, 1061902, 1061903, 1061904,
    1061905, 1061906, 1061907, 1061908, 1061909, 1061910, 1061911,
    1061912, 1061913, 1061914, 1061915, 1061916, 1061917, 1061921,
    1061922, 1061923, 1061937, 1061938, 1061940, 1061943, 1062155,
    1062156, 1062558, 1062559, 1062560, 1062561, 1062562, 1062563,
    1062565, 1062566, 1062567, 1062568, 1062569, 1062570, 1062571,
    1062572, 1062707, 1062713, 1062714, 1062716, 1062719, 1062720,
    1062721, 1062767, 1062768, 1062769, 1062770, 1062771, 1062772,
    1062773, 1062774, 1062776, 1062782, 1062783, 1062784, 1063609,
    1063610, 1063613, 1063615, 1064053, 1064054, 1064056, 1064059,
    1064060, 1064061, 1064101, 1064103, 1064105, 1064165, 1064167,
    1064168, 1064169, 1064170, 1064171, 1064172, 1064173, 1064237,
    1064323, 1064324, 1064325, 1064326, 1064327, 1064329, 1064330,
    1064331, 1064332, 1064333, 1064334, 1064335, 1064409, 1064410,
    1064415, 1064416, 1064490, 1064491, 1064495, 1064521, 1064523,
    1064529, 1065038, 1065039, 1065040, 1065041, 1065042, 1065043,
    1065044, 1065045, 1065046, 1065047, 1065048, 1065049, 1065050,
    1065149, 1065150, 1065151, 1065152, 1065153, 1065154, 1065155,
    1065156, 1065157, 1065158, 1065159, 1065160, 1065161, 1065162,
    1065163, 1065164, 1065165, 1065166, 1065167, 1065168, 1065169,
    1065170, 1065171, 1065196, 1065345, 1065347, 1065349, 1065352,
    1065353, 1065354, 1065356, 1065360, 1065361, 1065363, 1065364,
    1065365, 1065367, 1065380, 1065382, 1066517, 1066901, 1066902,
    1066903, 1066904, 1066905, 1066906, 1066907, 1067023, 1067024,
    1067345, 1067346, 1067347, 1067348, 1067383, 1067384, 1067385,
    1067387, 1067388, 1067389, 1067390, 1067393, 1067394, 1067395,
    1067396, 1067397, 1067398, 1067399, 1067400, 1067497, 1067499,
    1067500, 1067851, 1067852, 1067853, 1067861, 1067862, 1067863,
    1067864, 1067866, 1067867, 1068723, 1068724, 1068733, 1068734,
    1068772, 1068774, 1068775, 1068776, 1068782, 1068783, 1068784,
    1068785, 1068786, 1068787, 1068788, 1068861, 1068982, 1068983,
    1069087, 1069088, 1069089, 1069090, 1070120, 1070122, 1070124,
    1070125, 1070324, 1070395, 1071234, 1071236, 1071594, 1071595,
    1071596, 1071670, 1071671, 1071673, 1071674, 1071678, 1072174,
    1072175, 1072176, 1072418, 1072492, 1072493, 1072494, 1072495,
    1072500, 1072501, 1072502, 1072521, 1072618, 1072625, 1072791,
    1072792, 1072793, 1072794, 1072795, 1072796, 1072797, 1072799,
    1072800, 1072801, 1072804, 1072808, 1072850, 1073256, 1073318,
    1073319, 1073320, 1073321, 1073407, 1073408, 1073409, 1073704,
    1074949, 1074952, 1074953, 1074954, 1074982, 1074984, 1074985,
    1074986, 1074987, 1075031
]

print("=" * 100)
print("누락된 리뷰 크롤링")
print("=" * 100)
print(f"\n대상 제품: {len(missing_codes)}개")
print("크롤링 대상: 리뷰만")
print("=" * 100)

# 자동 시작
print("\n크롤링을 시작합니다")

# Chrome 옵션
chrome_options = Options()
chrome_options.add_argument('--no-sandbox')
chrome_options.add_argument('--disable-dev-shm-usage')

# 드라이버 초기화
driver = webdriver.Chrome(
    service=Service(ChromeDriverManager().install()),
    options=chrome_options
)

all_reviews = []
failed_products = []

# 제품별 크롤링
for idx, product_code in enumerate(missing_codes, 1):
    url = f"https://www.daisomall.co.kr/pd/pdr/SCR_PDR_0001?pdNo={product_code}&recmYn=N"

    print(f"[{idx}/{len(missing_codes)}] 제품 {product_code}", end=" ")
    logger.info(f"제품 {product_code} 리뷰 크롤링 시작")

    try:
        # 리뷰만 크롤링
        product, reviews, ingredients = crawl_product_detail(
            driver, url,
            category_home="뷰티",
            category_1="",
            category_2="",
            crawl_reviews=True,   # 리뷰만 수집
            crawl_ingredients=False  # 성분 제외
        )

        if reviews:
            all_reviews.extend(reviews)
            print(f"{len(reviews)}개 리뷰")
            logger.info(f"  → {len(reviews)}개 리뷰 수집")
        else:
            print(f"리뷰 없음")
            logger.warning(f"  → 리뷰 없음")

    except Exception as e:
        print(f"X")
        logger.error(f"  → 오류: {str(e)}")
        failed_products.append(product_code)

    time.sleep(1.5)

driver.quit()

# 결과 저장
print("\n" + "=" * 100)
print("크롤링 완료 - 결과 저장")
print("=" * 100)

timestamp = get_date_string()

# 리뷰 데이터
if all_reviews:
    reviews_df = pd.DataFrame(all_reviews)

    # mancare_reviews.csv와 동일한 컬럼만 선택: product_code, date, user_masked, rating, text, image_count
    columns_to_keep = ['product_code', 'date', 'user_masked', 'rating', 'text', 'image_count']
    reviews_df = reviews_df[columns_to_keep]

    reviews_path = f'/Users/yu_seok/Documents/workspace/nbCamp/Project/Why-pi/data/missing_reviews_{timestamp}.csv'
    reviews_df.to_csv(reviews_path, index=False, encoding='utf-8-sig')
    print(f"\n 리뷰 데이터: {reviews_path}")
    print(f"   총 {len(reviews_df):,}개 리뷰")

    # 제품별 리뷰 통계
    review_counts = reviews_df.groupby('product_code').size().reset_index(name='review_count')
    print(f"\n 리뷰 수집 통계:")
    print(f"   - 리뷰 있음: {len(review_counts)}개 제품")
    print(f"   - 리뷰 없음: {len(missing_codes) - len(review_counts)}개 제품")
    print(f"   - 평균 리뷰 수: {review_counts['review_count'].mean():.1f}개")
else:
    print("\n  리뷰 데이터 없음")

# 실패 목록
if failed_products:
    print(f"\n 실패한 제품 ({len(failed_products)}개):")
    print(f"   {failed_products[:10]}")
    if len(failed_products) > 10:
        print(f"    외 {len(failed_products) - 10}개")

# 통계
success_count = len(missing_codes) - len(failed_products)
total_count = len(missing_codes)
success_rate = success_count / total_count * 100 if total_count > 0 else 0

print(f"\n최종 통계:")
print(f"   - 전체: {total_count}개")
print(f"   - 성공: {success_count}개 ({success_rate:.1f}%)")
print(f"   - 실패: {len(failed_products)}개 ({100-success_rate:.1f}%)")

print("\n" + "=" * 100)
print("완료!")
print("=" * 100)
